<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit Pro | Premium Expense Cloud</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --primary: #6366f1; 
            --primary-dark: #4f46e5;
            --bg: #f8fafc; 
            --card: #ffffff;
        }
        
        body { 
            background: var(--bg); 
            color: #1e293b; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh; 
            letter-spacing: -0.01em;
        }

        /* Glassmorphism & Silk UI */
        .silk-card { 
            background: var(--card); 
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); 
            border-radius: 2rem; 
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); }

        /* Smooth View Transitions */
        .view-pane { display: none; opacity: 0; transform: translateY(10px); }
        .view-pane.active-view { 
            display: block; 
            animation: paneIn 0.5s forwards ease-out; 
        }

        @keyframes paneIn { 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Admin Specific Styling */
        .admin-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .status-badge { padding: 4px 12px; border-radius: 99px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .nav-fixed {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
            z-index: 100; width: calc(100% - 2rem); max-width: 500px;
        }
    </style>
</head>
<body class="antialiased">

    <div id="toast-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[300] space-y-2 pointer-events-none"></div>

    <div id="auth-screen" class="fixed inset-0 z-[200] bg-white flex items-center justify-center p-6">
        <div id="login-container" class="text-center w-full max-w-sm space-y-8">
            <div>
                <h1 class="text-5xl font-extrabold tracking-tighter text-gray-900">TripSplit <span class="text-indigo-600">Pro</span></h1>
                <p class="text-gray-400 font-medium mt-2">The Ultimate Expense Cloud</p>
            </div>
            <button id="google-login-btn" class="w-full silk-card p-5 flex items-center justify-center gap-4 hover:bg-gray-50 transition-all active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                <span class="font-bold text-lg">Sign in with Google</span>
            </button>
        </div>

        <div id="group-discovery" class="hidden w-full max-w-lg p-6">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-extrabold">Your Circles</h2>
                    <p class="text-sm text-gray-500 font-medium">Select a workspace to begin</p>
                </div>
                <button onclick="signOutNow()" class="text-red-500 font-bold text-xs bg-red-50 px-4 py-2 rounded-xl">SIGN OUT</button>
            </div>
            <div id="my-groups-list" class="grid gap-4 mb-8 max-h-[50vh] overflow-y-auto pr-2"></div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="showJoinManual()" class="p-4 silk-card text-gray-600 font-bold border-dashed border-2">Join Circle</button>
                <button onclick="showCreationPopup()" class="p-4 btn-primary text-white rounded-[2rem] font-bold shadow-lg">New Circle</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden pb-32 pt-10 px-4 md:px-10 max-w-7xl mx-auto">
        
        <header class="flex items-center justify-between mb-12">
            <div class="flex items-center gap-4">
                <div class="relative group cursor-pointer" onclick="showView('profile-page')">
                    <img id="user-photo" src="" class="w-14 h-14 rounded-[1.5rem] border-2 border-white shadow-lg group-hover:scale-105 transition-transform">
                    <div id="user-sub-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[10px] hidden"><i class="fa-solid fa-crown"></i></div>
                </div>
                <div>
                    <h3 id="display-group-name" class="text-xl font-extrabold text-gray-900 leading-none">...</h3>
                    <button onclick="copyGroupId()" class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mt-1">Copy ID: <span id="current-id-tag" class="opacity-60"></span></button>
                </div>
            </div>

            <nav class="hidden md:flex bg-white/50 backdrop-blur-md p-1.5 rounded-[1.8rem] border border-white shadow-sm">
                <button onclick="showView('main-dashboard')" class="px-6 py-2.5 rounded-[1.4rem] text-sm font-bold text-gray-500 hover:text-indigo-600 transition-all">Home</button>
                <button onclick="showView('plans-page')" class="px-6 py-2.5 rounded-[1.4rem] text-sm font-bold text-gray-500 hover:text-indigo-600">Pro Plans</button>
                <button id="admin-nav-btn" onclick="showView('admin-center')" class="px-6 py-2.5 rounded-[1.4rem] text-sm font-bold text-indigo-600 hidden"><i class="fa-solid fa-shield-halved mr-2"></i>Admin</button>
                <button onclick="showView('settings-page')" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-900 text-white ml-2"><i class="fa-solid fa-gear text-xs"></i></button>
            </nav>
        </header>

        <main id="main-dashboard" class="view-pane active-view">
            <div id="global-announcement" class="hidden mb-8 p-4 bg-indigo-600 text-white rounded-3xl flex items-center gap-4 shadow-xl animate-pulse">
                <i class="fa-solid fa-bullhorn text-xl"></i>
                <p id="announcement-text" class="text-sm font-bold"></p>
            </div>

            <div id="stats-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-12"></div>

            <div class="grid lg:grid-cols-12 gap-10">
                <div class="lg:col-span-4 space-y-6">
                    <div class="silk-card p-8 sticky top-10">
                        <h4 class="text-sm font-black text-gray-400 uppercase tracking-[0.2em] mb-6">Log Transaction</h4>
                        <div class="space-y-4">
                            <input type="text" id="bill-title" placeholder="Description" class="w-full bg-gray-50 p-4 rounded-2xl font-bold border-none focus:ring-2 ring-indigo-100 transition-all">
                            <div class="relative">
                                <span class="absolute left-4 top-4 font-black text-gray-400">₹</span>
                                <input type="number" id="bill-amount" placeholder="0.00" class="w-full bg-gray-50 p-4 pl-10 rounded-2xl text-2xl font-black border-none focus:ring-2 ring-indigo-100">
                            </div>
                            <div class="pt-2">
                                <p class="text-[10px] font-black text-gray-400 uppercase mb-3 px-1">Split Between</p>
                                <div id="split-selectors" class="flex flex-wrap gap-2"></div>
                            </div>
                            <button onclick="logExpense()" class="w-full btn-primary py-5 rounded-[1.5rem] text-white font-black uppercase tracking-widest mt-4">Publish To Cloud</button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="flex justify-between items-end mb-6 px-2">
                        <h4 class="text-2xl font-black">History</h4>
                        <p class="text-sm font-bold text-gray-400">Total Group Spend: <span id="grand-total" class="text-indigo-600">₹0</span></p>
                    </div>
                    <div id="activity-feed" class="space-y-4"></div>
                </div>
            </div>
        </main>

        <div id="admin-center" class="view-pane">
            <div class="mb-10 text-center">
                <h2 class="text-4xl font-black tracking-tighter">Command Center</h2>
                <p class="text-indigo-600 font-bold uppercase text-[10px] tracking-[0.3em]">System Administrator</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="silk-card p-8 text-center bg-white">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-2">Total Communities</p>
                    <p id="admin-total-groups" class="text-4xl font-black text-gray-900">0</p>
                </div>
                <div class="silk-card p-8 text-center bg-white">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-2">Total Users</p>
                    <p id="admin-total-users" class="text-4xl font-black text-indigo-600">0</p>
                </div>
                <div class="silk-card p-8 text-center bg-white">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-2">Hottest Circle</p>
                    <p id="admin-top-group" class="text-lg font-black text-gray-900 truncate px-2">...</p>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-10">
                <div class="silk-card p-8">
                    <h3 class="text-xl font-black mb-6 flex items-center gap-3">
                        Pending Approvals <span id="sub-req-count" class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-lg">0</span>
                    </h3>
                    <div id="admin-sub-list" class="space-y-4 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>

                <div class="silk-card p-8">
                    <h3 class="text-xl font-black mb-6">Global Broadcast</h3>
                    <div class="space-y-4">
                        <textarea id="announcement-input" placeholder="Enter message for all users..." class="w-full bg-gray-50 p-4 rounded-2xl font-medium border-none h-32 focus:ring-2 ring-indigo-100"></textarea>
                        <button onclick="postAnnouncement()" class="w-full admin-gradient text-white py-4 rounded-[1.2rem] font-bold">Broadcast to Everyone</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="plans-page" class="view-pane">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-black tracking-tighter mb-4">Upgrade Your Experience</h2>
                    <p class="text-gray-500 font-medium">Power up your circles with premium cloud features</p>
                </div>
                <div id="pricing-cards" class="grid md:grid-cols-3 gap-8">
                    <div class="silk-card p-8 flex flex-col items-center text-center hover:shadow-2xl transition-all border-2 border-indigo-600 relative overflow-hidden">
                        <div class="absolute top-4 -right-8 bg-indigo-600 text-white px-10 py-1 rotate-45 text-[8px] font-black uppercase">POPULAR</div>
                        <h4 class="text-2xl font-black mb-2">Standard</h4>
                        <p class="text-4xl font-black mb-6">₹100 <span class="text-sm text-gray-400 font-bold">/month</span></p>
                        <ul class="text-sm font-bold text-gray-500 space-y-3 mb-10 text-left w-full">
                            <li><i class="fa-solid fa-circle-check text-indigo-600 mr-2"></i> Up to 10 Groups</li>
                            <li><i class="fa-solid fa-circle-check text-indigo-600 mr-2"></i> 20 Members per Circle</li>
                            <li><i class="fa-solid fa-circle-check text-indigo-600 mr-2"></i> Real-time Push Alerts</li>
                        </ul>
                        <button onclick="requestUpgrade('Standard', 100)" class="w-full btn-primary text-white py-4 rounded-2xl font-black uppercase">Get Standard</button>
                    </div>
                    </div>
                
                <div id="payment-box" class="hidden mt-12 max-w-sm mx-auto silk-card p-8 bg-indigo-50 border-indigo-200">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-indigo-600 uppercase mb-4 tracking-widest">Manual Payment Gateway</p>
                        <img id="payment-qr" src="" class="w-full aspect-square rounded-2xl mb-6 shadow-lg border-4 border-white">
                        <p class="font-bold text-sm text-gray-500 mb-6">Pay <span id="pay-amt" class="text-gray-900">₹0</span> and enter Transaction ID below</p>
                        <input type="text" id="tx-id" placeholder="Transaction ID" class="w-full p-4 rounded-xl font-bold text-center mb-4 uppercase">
                        <button onclick="submitSubRequest()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold">Submit for Approval</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-page" class="view-pane max-w-lg mx-auto">
            <div class="silk-card p-10 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
                <img id="p-img" src="" class="w-24 h-24 rounded-[2rem] mx-auto mb-6 shadow-xl border-4 border-gray-50">
                <h2 id="p-name" class="text-3xl font-black">...</h2>
                <p id="p-email" class="text-gray-400 font-bold mb-4">...</p>
                <div id="p-status" class="status-badge bg-gray-100 text-gray-500 inline-block">Free Starter</div>
                
                <div class="mt-10 space-y-3">
                    <button onclick="showView('plans-page')" class="w-full py-4 bg-indigo-50 text-indigo-600 rounded-2xl font-bold hover:bg-indigo-100 transition-all">Manage Subscription</button>
                    <button onclick="signOutNow()" class="w-full py-4 text-red-500 font-bold">Logout Session</button>
                </div>
            </div>
        </div>

        <div id="settings-page" class="view-pane max-w-2xl mx-auto">
            <h2 class="text-3xl font-black mb-8 px-4">Workspace Settings</h2>
            <div class="space-y-4">
                <div class="silk-card p-6 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Circle Name</p>
                        <h4 id="set-group-name" class="text-xl font-black">...</h4>
                    </div>
                    <button class="w-10 h-10 rounded-xl bg-gray-50 text-gray-400"><i class="fa-solid fa-pen text-xs"></i></button>
                </div>
                
                <div class="silk-card p-8">
                    <h5 class="font-black mb-6">Participants</h5>
                    <div id="member-settings-list" class="space-y-3"></div>
                    <div id="admin-add-area" class="hidden mt-6 pt-6 border-t">
                        <p class="text-[10px] font-black text-indigo-600 uppercase mb-4">Admin: Add Member Manually</p>
                        <div class="flex gap-2">
                            <input type="text" id="manual-mem-name" placeholder="Name" class="flex-1 bg-gray-50 p-4 rounded-xl text-sm font-bold">
                            <input type="email" id="manual-mem-email" placeholder="Email" class="flex-1 bg-gray-50 p-4 rounded-xl text-sm font-bold">
                            <button onclick="adminAddMember()" class="bg-gray-900 text-white px-6 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="p-8 text-center silk-card bg-red-50 border-red-100 mt-10">
                    <p class="text-xs font-bold text-red-500 mb-4 uppercase">Danger Zone</p>
                    <button onclick="deleteCurrentCircle()" class="bg-red-500 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-lg shadow-red-200">Delete This Circle Permanently</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="md:hidden nav-fixed bg-white/80 backdrop-blur-xl border border-white p-2 rounded-[2.5rem] flex items-center justify-around shadow-2xl">
        <button onclick="showView('main-dashboard')" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 active:text-indigo-600"><i class="fa-solid fa-house"></i></button>
        <button onclick="showView('plans-page')" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 active:text-indigo-600"><i class="fa-solid fa-crown"></i></button>
        <button id="mobile-admin-btn" onclick="showView('admin-center')" class="w-12 h-12 rounded-full hidden items-center justify-center text-indigo-600"><i class="fa-solid fa-lock-open"></i></button>
        <button onclick="showView('settings-page')" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 active:text-indigo-600"><i class="fa-solid fa-users"></i></button>
        <button onclick="showView('profile-page')" class="w-12 h-12 rounded-full overflow-hidden border-2 border-transparent active:border-indigo-600"><img id="mobile-p-img" src="" class="w-full h-full object-cover"></button>
    </nav>

    <div id="modal-overlay" class="fixed inset-0 z-[150] bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center p-6">
        <div id="modal-content" class="silk-card bg-white w-full max-w-sm p-8 shadow-2xl scale-95 transition-transform"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCpLtdJ4lACW9pNn8fAUmooooqzh_5TIO4", 
            authDomain: "trip-ddc48.firebaseapp.com", 
            databaseURL: "https://trip-ddc48-default-rtdb.firebaseio.com", 
            projectId: "trip-ddc48", 
            storageBucket: "trip-ddc48.firebasestorage.app" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        const ADMIN_EMAIL = "akhilgoel985@gmail.com";
        let currentGroupId = null, groupMembers = [], userPlan = 'Free';

        /* 1. AUTH & ADMIN GATEKEEPER */
        auth.onAuthStateChanged(u => {
            if (u) {
                const isSystemAdmin = u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                document.getElementById('user-photo').src = u.photoURL;
                document.getElementById('mobile-p-img').src = u.photoURL;
                document.getElementById('p-img').src = u.photoURL;
                document.getElementById('p-name').innerText = u.displayName;
                document.getElementById('p-email').innerText = u.email;
                
                if (isSystemAdmin) {
                    document.getElementById('admin-nav-btn').classList.remove('hidden');
                    document.getElementById('mobile-admin-btn').classList.remove('hidden');
                    document.getElementById('mobile-admin-btn').style.display = 'flex';
                    initAdminPanel();
                }

                loadUserSubscription(u.uid);
                discoverUserGroups(u.email.toLowerCase());
                listenForAnnouncements();
            } else {
                toggleLogin(true);
            }
        });

        function loadUserSubscription(uid) {
            db.ref(`active_subscriptions/${uid}`).on('value', snap => {
                const sub = snap.val();
                userPlan = sub ? sub.tier : 'Free';
                document.getElementById('p-status').innerText = userPlan + " Plan";
                document.getElementById('p-status').className = `status-badge ${sub ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-500'} inline-block`;
                document.getElementById('user-sub-badge').classList.toggle('hidden', !sub);
            });
        }

        /* 2. CORE UI FUNCTIONS */
        function showView(viewId) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active-view'));
            const target = document.getElementById(viewId);
            target.classList.add('active-view');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 silk-card text-xs font-black uppercase tracking-widest shadow-2xl flex items-center gap-3 animate-bounce-short pointer-events-auto bg-white`;
            toast.innerHTML = `<div class="w-2 h-2 rounded-full ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}"></div> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        /* 3. GROUP MANAGEMENT */
        function discoverUserGroups(email) {
            db.ref('groups').on('value', snap => {
                const list = document.getElementById('my-groups-list');
                list.innerHTML = '';
                if (snap.exists()) {
                    snap.forEach(gSnap => {
                        const g = gSnap.val();
                        if (g.members?.some(m => m.email.toLowerCase() === email)) {
                            const card = document.createElement('div');
                            card.className = "silk-card p-6 flex justify-between items-center cursor-pointer hover:border-indigo-200 transition-all";
                            card.onclick = () => selectGroup(gSnap.key, g.name);
                            card.innerHTML = `
                                <div>
                                    <h4 class="font-black text-gray-800">${g.name}</h4>
                                    <p class="text-[10px] font-bold text-indigo-500 uppercase">${gSnap.key}</p>
                                </div>
                                <i class="fa-solid fa-chevron-right text-gray-300"></i>
                            `;
                            list.innerHTML += card.outerHTML;
                        }
                    });
                }
                toggleLogin(false);
            });
        }

        function selectGroup(id, name) {
            currentGroupId = id;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('display-group-name').innerText = name;
            document.getElementById('set-group-name').innerText = name;
            document.getElementById('current-id-tag').innerText = id;
            
            db.ref(`groups/${id}`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                groupMembers = data.members || [];
                const isAdminOfGroup = data.admin.toLowerCase() === auth.currentUser.email.toLowerCase();
                document.getElementById('admin-add-area').classList.toggle('hidden', !isAdminOfGroup);
                renderDashboard(data.expenses || {});
                renderSettingsMembers(data.admin);
            });
        }

        /* 4. DASHBOARD & SPLITTING LOGIC */
        function renderDashboard(expenses) {
            // Stats & Splitting
            let totalSpend = 0;
            let balances = {};
            groupMembers.forEach(m => balances[m.name] = 0);

            const feed = document.getElementById('activity-feed');
            feed.innerHTML = '';

            const expArr = Object.entries(expenses).reverse();
            expArr.forEach(([key, e]) => {
                const amount = parseFloat(e.amount);
                if (e.type === 'settlement') {
                    balances[e.payer] -= amount;
                } else if (e.type === 'announcement') {
                    // System Notification in timeline
                } else {
                    totalSpend += amount;
                    const split = amount / (e.involved?.length || 1);
                    e.involved?.forEach(name => balances[name] += split);
                }

                // UI Feed Item
                const isSystem = e.type === 'announcement';
                feed.innerHTML += `
                    <div class="p-6 silk-card ${isSystem ? 'bg-indigo-50 border-indigo-100' : ''} flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl ${isSystem ? 'bg-indigo-600' : 'bg-gray-100'} flex items-center justify-center text-white">
                                <i class="fa-solid ${isSystem ? 'fa-bullhorn' : 'fa-receipt text-gray-400'}"></i>
                            </div>
                            <div>
                                <h5 class="font-black text-sm">${e.title}</h5>
                                <p class="text-[10px] font-bold text-gray-400 uppercase">${e.date} • by ${e.by}</p>
                            </div>
                        </div>
                        <p class="text-xl font-black ${isSystem ? 'text-indigo-600' : 'text-gray-900'}">₹${amount}</p>
                    </div>
                `;
            });

            document.getElementById('grand-total').innerText = "₹" + totalSpend.toLocaleString();

            // Render Member Stats
            const stats = document.getElementById('stats-grid');
            stats.innerHTML = groupMembers.map((m, i) => `
                <div class="silk-card p-6 text-center">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-2">${m.name}</p>
                    <p class="text-2xl font-black">₹${Math.round(balances[m.name])}</p>
                </div>
            `).join('');

            // Fill log expense selectors
            document.getElementById('split-selectors').innerHTML = groupMembers.map(m => `
                <button onclick="this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white');" 
                        class="chip px-4 py-2 rounded-xl text-xs font-bold border border-gray-100 bg-white" data-name="${m.name}">${m.name}</button>
            `).join('');
        }

        /* 5. ADMIN COMMAND CENTER ENGINE */
        function initAdminPanel() {
            // Aggregate Data
            db.ref('groups').on('value', snap => {
                const groups = snap.val() || {};
                const groupKeys = Object.keys(groups);
                let totalUsers = 0;
                let topGroup = { name: 'None', count: 0 };

                groupKeys.forEach(k => {
                    const count = groups[k].members?.length || 0;
                    totalUsers += count;
                    if (count > topGroup.count) topGroup = { name: groups[k].name, count: count };
                });

                document.getElementById('admin-total-groups').innerText = groupKeys.length;
                document.getElementById('admin-total-users').innerText = totalUsers;
                document.getElementById('admin-top-group').innerText = topGroup.name;
            });

            // Subscription Requests Listener
            db.ref('subscription_requests').on('value', snap => {
                const list = document.getElementById('admin-sub-list');
                const countBadge = document.getElementById('sub-req-count');
                list.innerHTML = '';
                
                if (!snap.exists()) {
                    list.innerHTML = '<p class="text-center py-10 text-gray-400 font-bold">No pending requests</p>';
                    countBadge.innerText = 0;
                    return;
                }

                countBadge.innerText = Object.keys(snap.val()).length;

                snap.forEach(reqSnap => {
                    const r = reqSnap.val();
                    list.innerHTML += `
                        <div class="p-5 silk-card bg-white border-2 border-indigo-50">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="font-black text-sm">${r.userName}</h4>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">${r.userEmail}</p>
                                </div>
                                <span class="bg-indigo-600 text-white text-[8px] px-2 py-1 rounded font-black">${r.tier}</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl mb-4 text-xs font-mono break-all">${r.txId}</div>
                            <div class="flex gap-2">
                                <button onclick="resolveSubscription('${reqSnap.key}', '${r.uid}', true, '${r.tier}')" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase">Approve</button>
                                <button onclick="resolveSubscription('${reqSnap.key}', '${r.uid}', false)" class="flex-1 py-3 bg-red-50 text-red-500 rounded-xl text-[10px] font-black uppercase">Deny</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function resolveSubscription(reqKey, uid, approve, tier) {
            if (approve) {
                // 1. Activate Sub
                await db.ref(`active_subscriptions/${uid}`).set({ tier: tier, date: new Date().toLocaleDateString() });
                
                // 2. Notify in all groups user belongs to (Simplified: post to system log)
                await db.ref('announcements').push({
                    text: `Congratulations! A user has just upgraded to ${tier} Pro!`,
                    type: 'system'
                });

                showToast(`Sub Activated for UID: ${uid.substring(0,5)}...`);
            } else {
                showToast("Request Rejected", "error");
            }
            // Clear request
            await db.ref(`subscription_requests/${reqKey}`).remove();
        }

        function postAnnouncement() {
            const txt = document.getElementById('announcement-input').value.trim();
            if (!txt) return;
            db.ref('announcements').push({
                text: txt,
                by: 'System Admin',
                date: new Date().toLocaleDateString()
            });
            document.getElementById('announcement-input').value = '';
            showToast("Global Broadcast Sent!");
        }

        function listenForAnnouncements() {
            db.ref('announcements').limitToLast(1).on('child_added', snap => {
                const a = snap.val();
                const bar = document.getElementById('global-announcement');
                document.getElementById('announcement-text').innerText = a.text;
                bar.classList.remove('hidden');
                setTimeout(() => bar.classList.add('hidden'), 10000);
            });
        }

        /* 6. UPGRADE FLOW */
        let activeUpgrade = null;
        function requestUpgrade(tier, price) {
            activeUpgrade = { tier, price };
            const upi = `upi://pay?pa=akhilgoel985-2@okaxis&pn=Akhil%20Goel&am=${price}&cu=INR&tn=TripSplitPro_${tier}`;
            document.getElementById('payment-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upi)}`;
            document.getElementById('pay-amt').innerText = `₹${price}`;
            document.getElementById('payment-box').classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function submitSubRequest() {
            const tx = document.getElementById('tx-id').value.trim();
            if (!tx) return showToast("Enter Transaction ID", "error");

            await db.ref('subscription_requests').push({
                uid: auth.currentUser.uid,
                userName: auth.currentUser.displayName,
                userEmail: auth.currentUser.email,
                tier: activeUpgrade.tier,
                txId: tx,
                status: 'pending'
            });

            showToast("Request Submitted! Verification takes 1-2 hours.");
            document.getElementById('payment-box').classList.add('hidden');
            document.getElementById('tx-id').value = '';
        }

        /* UTILS */
        function toggleLogin(show) {
            document.getElementById('login-container').classList.toggle('hidden', !show);
            document.getElementById('group-discovery').classList.toggle('hidden', show);
        }

        window.logExpense = () => {
            const t = document.getElementById('bill-title').value;
            const a = document.getElementById('bill-amount').value;
            const inv = Array.from(document.querySelectorAll('#split-selectors .bg-indigo-600')).map(b => b.dataset.name);
            
            if (!t || !a || inv.length === 0) return showToast("Fill all fields", "error");

            db.ref(`groups/${currentGroupId}/expenses`).push({
                title: t,
                amount: a,
                involved: inv,
                by: auth.currentUser.displayName.split(' ')[0],
                date: new Date().toLocaleDateString(),
                type: 'expense'
            });

            document.getElementById('bill-title').value = '';
            document.getElementById('bill-amount').value = '';
            showToast("Transaction Logged");
        };

        window.copyGroupId = () => {
            navigator.clipboard.writeText(currentGroupId);
            showToast("ID Copied to Clipboard");
        };

        window.signOutNow = () => auth.signOut().then(() => location.reload());
        document.getElementById('google-login-btn').onclick = () => auth.signInWithPopup(provider);

        // Pre-initialization
        showView('main-dashboard');

    </script>
</body>
</html>
