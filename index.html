<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit Pro | Premium Expense Cloud</title>
    
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f43f5e;
            --bg: #f8fafc;
            --glass: rgba(255, 255, 255, 0.7);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Sophisticated UI Components --- */
        .silk-card {
            background: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            border-radius: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .silk-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 100;
        }

        /* --- Transitions --- */
        .view-pane {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .view-pane.active-view {
            display: block;
            animation: slideUp 0.6s forwards cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes slideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Buttons --- */
        .btn-premium {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 1.25rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
        }

        .btn-premium:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .btn-premium:active {
            transform: scale(0.98);
        }

        /* --- Navigation --- */
        .nav-item {
            color: #94a3b8;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* --- Admin Specific --- */
        .admin-glow {
            position: relative;
            overflow: hidden;
        }
        .admin-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .badge-pro {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 800;
            text-transform: uppercase;
        }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Styling */
        .toast {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: toastIn 0.4s ease forwards;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="toast-container"></div>

    <div id="auth-screen" class="fixed inset-0 z-[500] bg-white flex items-center justify-center p-6">
        <div id="login-container" class="w-full max-w-sm text-center">
            <div class="mb-12">
                <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center shadow-2xl shadow-indigo-200">
                    <i class="fa-solid fa-cloud-bolt text-white text-4xl"></i>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tighter mb-2">TripSplit <span class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-400 font-medium">The Elite Cloud for Shared Expenses</p>
            </div>
            
            <button id="google-login-btn" class="w-full silk-card py-5 flex items-center justify-center gap-4 hover:bg-slate-50 border-none transition-all active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6">
                <span class="font-bold text-lg">Continue with Google</span>
            </button>
        </div>

        <div id="group-discovery" class="hidden w-full max-w-lg p-4">
            <div class="flex justify-between items-end mb-8 px-2">
                <div>
                    <h2 class="text-3xl font-extrabold">My Circles</h2>
                    <p class="text-slate-400 font-medium">Choose a workspace to enter</p>
                </div>
                <button onclick="signOut()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-black">LOGOUT</button>
            </div>
            <div id="discovery-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                </div>
            <div class="grid grid-cols-2 gap-4 mt-8">
                <button onclick="openModal('modal-join')" class="p-4 silk-card text-slate-500 font-bold border-dashed border-2 hover:border-indigo-300">Join Circle</button>
                <button onclick="openModal('modal-create')" class="btn-premium p-4 rounded-[2rem] shadow-xl">New Circle</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden min-h-screen">
        
        <header class="glass-header fixed top-0 left-0 right-0 h-20 flex items-center px-4 md:px-10 justify-between">
            <div class="flex items-center gap-4">
                <div class="relative group cursor-pointer" onclick="showView('view-profile')">
                    <img id="header-avatar" src="" class="w-11 h-11 rounded-2xl shadow-lg border-2 border-white group-hover:scale-110 transition-transform">
                    <div id="sub-crown" class="absolute -top-1 -right-1 bg-amber-500 text-white w-4 h-4 rounded-full flex items-center justify-center text-[8px] hidden"><i class="fa-solid fa-crown"></i></div>
                </div>
                <div>
                    <h3 id="current-group-name" class="font-extrabold text-slate-900 leading-none">Loading...</h3>
                    <p onclick="copyID()" class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mt-1 cursor-pointer hover:text-indigo-700 transition-colors">
                        ID: <span id="current-group-id-display">#0000</span> <i class="fa-solid fa-copy ml-1"></i>
                    </p>
                </div>
            </div>

            <nav class="hidden lg:flex items-center gap-2 bg-slate-100/50 p-1.5 rounded-2xl">
                <button onclick="showView('view-dashboard')" class="nav-btn-desktop px-5 py-2 rounded-xl text-sm font-bold text-slate-500 transition-all active-nav">Home</button>
                <button onclick="showView('view-plans')" class="nav-btn-desktop px-5 py-2 rounded-xl text-sm font-bold text-slate-500 transition-all">Subscriptions</button>
                <button id="admin-nav-desktop" onclick="showView('view-admin')" class="nav-btn-desktop px-5 py-2 rounded-xl text-sm font-bold text-indigo-600 hidden"><i class="fa-solid fa-shield-halved mr-1"></i> Admin</button>
                <button onclick="showView('view-settings')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm ml-2 text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-sliders"></i></button>
            </nav>
        </header>

        <main class="pt-28 pb-32 px-4 md:px-10 max-w-7xl mx-auto">
            
            <div id="view-dashboard" class="view-pane active-view">
                <div id="global-announcement" class="hidden silk-card bg-indigo-600 border-none p-4 mb-8 flex items-center gap-4 text-white shadow-indigo-200">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center"><i class="fa-solid fa-bullhorn"></i></div>
                    <p id="announcement-msg" class="text-sm font-bold"></p>
                </div>

                <div id="dashboard-stats" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
                    </div>

                <div class="grid lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4">
                        <div class="silk-card p-8 sticky top-28">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">New Transaction</h4>
                            <div class="space-y-5">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">What for?</label>
                                    <input type="text" id="log-title" placeholder="Dinner, Taxi, Fuel..." class="w-full bg-slate-50 p-4 rounded-2xl font-bold border-none outline-none focus:ring-2 ring-indigo-100 transition-all">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">How much?</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-300 text-lg">₹</span>
                                        <input type="number" id="log-amount" placeholder="0.00" class="w-full bg-slate-50 p-4 pl-10 rounded-2xl text-2xl font-black border-none outline-none focus:ring-2 ring-indigo-100">
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Split with</label>
                                    <div id="split-selectors" class="flex flex-wrap gap-2">
                                        </div>
                                </div>
                                <button onclick="publishTransaction()" class="w-full btn-premium py-5 mt-4 text-sm font-black uppercase tracking-tighter">Publish to Cloud</button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-8">
                        <div class="flex justify-between items-end mb-6 px-2">
                            <h3 class="text-2xl font-black">Timeline</h3>
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Grand Total Spend</p>
                                <p id="grand-total" class="text-lg font-black text-indigo-600">₹0</p>
                            </div>
                        </div>
                        <div id="timeline-feed" class="space-y-4">
                            </div>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="view-pane">
                <div class="mb-12 text-center">
                    <h2 class="text-4xl font-black tracking-tighter mb-2">Command Center</h2>
                    <p class="text-indigo-600 font-bold uppercase text-[10px] tracking-[0.3em]">Authorized Personnel Only</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="silk-card p-8 bg-slate-900 text-white admin-glow">
                        <p class="text-[10px] font-bold opacity-50 uppercase mb-1">Total Communities</p>
                        <h4 id="admin-stat-groups" class="text-4xl font-black">0</h4>
                    </div>
                    <div class="silk-card p-8 bg-indigo-600 text-white admin-glow">
                        <p class="text-[10px] font-bold opacity-60 uppercase mb-1">Total Platform Users</p>
                        <h4 id="admin-stat-users" class="text-4xl font-black">0</h4>
                    </div>
                    <div class="silk-card p-8 bg-white text-slate-900 border-2 border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Largest Community</p>
                        <h4 id="admin-stat-top-group" class="text-xl font-black truncate">...</h4>
                    </div>
                </div>

                <div class="grid lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-7">
                        <div class="silk-card p-8">
                            <h3 class="text-xl font-black mb-6">Subscription Requests <span id="admin-sub-count" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-md ml-2">0</span></h3>
                            <div id="admin-sub-requests" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                                <div class="text-center py-20 text-slate-300 font-bold italic">No pending verifications</div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-5">
                        <div class="silk-card p-8 bg-slate-50 border-none">
                            <h3 class="text-xl font-black mb-6">Global Broadcast</h3>
                            <div class="space-y-4">
                                <textarea id="admin-broadcast-msg" placeholder="Message to all users..." class="w-full bg-white p-5 rounded-2xl h-40 border-none outline-none font-medium text-sm focus:ring-2 ring-indigo-200 shadow-inner"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="postBroadcast()" class="flex-1 btn-premium py-4">Push Global</button>
                                    <button onclick="clearBroadcast()" class="px-6 bg-white text-red-500 font-bold rounded-2xl border border-red-100">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-plans" class="view-pane">
                <div class="max-w-4xl mx-auto text-center mb-16">
                    <h2 class="text-4xl font-black tracking-tighter mb-4">Elite Cloud Plans</h2>
                    <p class="text-slate-500 font-medium">Power up your trips with unlimited participants and real-time cloud sync.</p>
                </div>

                <div class="grid md:grid-cols-3 gap-8 mb-16">
                    <div class="silk-card p-8 flex flex-col items-center text-center">
                        <h4 class="text-xl font-black text-slate-900 mb-2">Basic</h4>
                        <p class="text-4xl font-black text-slate-900 mb-6">₹50<span class="text-xs text-slate-400 font-bold">/month</span></p>
                        <ul class="text-sm font-bold text-slate-500 space-y-3 mb-10 w-full text-left">
                            <li><i class="fa-solid fa-check text-green-500 mr-2"></i> 2 Workspaces</li>
                            <li><i class="fa-solid fa-check text-green-500 mr-2"></i> 5 Members per Circle</li>
                            <li><i class="fa-solid fa-xmark text-slate-300 mr-2"></i> Global Analytics</li>
                        </ul>
                        <button onclick="requestSub('Basic', 50)" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition-all">Select Plan</button>
                    </div>

                    <div class="silk-card p-8 border-2 border-indigo-600 flex flex-col items-center text-center relative overflow-hidden scale-105 shadow-2xl">
                        <div class="absolute top-4 -right-8 bg-indigo-600 text-white px-10 py-1 rotate-45 text-[8px] font-black uppercase tracking-widest">MOST POPULAR</div>
                        <h4 class="text-xl font-black text-slate-900 mb-2">Standard</h4>
                        <p class="text-4xl font-black text-slate-900 mb-6">₹100<span class="text-xs text-slate-400 font-bold">/month</span></p>
                        <ul class="text-sm font-bold text-slate-500 space-y-3 mb-10 w-full text-left">
                            <li><i class="fa-solid fa-check text-indigo-600 mr-2"></i> 10 Workspaces</li>
                            <li><i class="fa-solid fa-check text-indigo-600 mr-2"></i> 20 Members per Circle</li>
                            <li><i class="fa-solid fa-check text-indigo-600 mr-2"></i> Priority Verification</li>
                        </ul>
                        <button onclick="requestSub('Standard', 100)" class="w-full btn-premium py-4 shadow-indigo-200">Get Standard</button>
                    </div>

                    <div class="silk-card p-8 bg-slate-900 text-white flex flex-col items-center text-center">
                        <h4 class="text-xl font-black mb-2">Premium</h4>
                        <p class="text-4xl font-black mb-6">₹250<span class="text-xs opacity-50 font-bold">/month</span></p>
                        <ul class="text-sm font-bold opacity-60 space-y-3 mb-10 w-full text-left">
                            <li><i class="fa-solid fa-bolt text-amber-400 mr-2"></i> Unlimited Everything</li>
                            <li><i class="fa-solid fa-bolt text-amber-400 mr-2"></i> Real-time Team Chat</li>
                            <li><i class="fa-solid fa-bolt text-amber-400 mr-2"></i> 24/7 VIP Support</li>
                        </ul>
                        <button onclick="requestSub('Premium', 250)" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold">Go Premium</button>
                    </div>
                </div>

                <div id="payment-gateway" class="hidden max-w-sm mx-auto animate-pulse">
                    <div class="silk-card p-10 bg-indigo-50 border-2 border-indigo-100 text-center">
                        <p class="text-[10px] font-black text-indigo-600 uppercase mb-4 tracking-widest">Manual UPI Verification</p>
                        <img id="qr-display" src="" class="w-48 h-48 mx-auto rounded-3xl border-4 border-white mb-6 shadow-xl">
                        <div class="mb-6">
                            <p class="text-sm font-bold text-slate-500">Amount to Pay: <span id="pay-amount-label" class="text-slate-900 font-black">₹0</span></p>
                            <p class="text-[9px] font-bold text-slate-400 mt-1 uppercase italic">Locked to: Akhil Goel</p>
                        </div>
                        <input type="text" id="pay-tx-id" placeholder="Enter Transaction ID" class="w-full p-4 rounded-xl font-bold text-center mb-4 uppercase text-sm border-none outline-none shadow-inner">
                        <button onclick="finalizeSubRequest()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-sm">Submit for Verification</button>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-pane max-w-2xl mx-auto">
                <h2 class="text-3xl font-black mb-8 px-2">Circle Settings</h2>
                <div class="space-y-4">
                    <div class="silk-card p-6 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase">Circle Name</p>
                            <h4 id="settings-group-name" class="text-xl font-extrabold">...</h4>
                        </div>
                        <button class="w-10 h-10 bg-slate-50 rounded-xl text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-pen"></i></button>
                    </div>

                    <div class="silk-card p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h5 class="font-black">Members Control</h5>
                            <span id="member-count-badge" class="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black">...</span>
                        </div>
                        <div id="settings-member-list" class="space-y-3">
                            </div>

                        <div id="admin-only-tools" class="hidden mt-8 pt-8 border-t border-slate-50">
                            <p class="text-[10px] font-black text-indigo-500 uppercase mb-4">Admin Dashboard Tools</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                                <input type="text" id="add-mem-name" placeholder="Full Name" class="bg-slate-50 p-4 rounded-xl text-sm font-bold border-none outline-none">
                                <input type="email" id="add-mem-email" placeholder="Email Address" class="bg-slate-50 p-4 rounded-xl text-sm font-bold border-none outline-none">
                            </div>
                            <button onclick="adminManualAdd()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-sm hover:shadow-lg transition-all">Add Participant Manually</button>
                        </div>
                    </div>

                    <div class="silk-card p-8 bg-red-50 border-red-100 mt-10 text-center">
                        <p class="text-xs font-black text-red-500 uppercase mb-4">Danger Zone</p>
                        <button onclick="confirmDeleteGroup()" class="bg-red-500 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-xl shadow-red-200">Dissolve This Circle</button>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="view-pane max-w-lg mx-auto">
                <div class="silk-card p-10 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
                    <img id="profile-img-large" src="" class="w-28 h-28 rounded-[2.5rem] mx-auto mb-6 shadow-2xl border-4 border-white">
                    <h2 id="profile-name" class="text-3xl font-black text-slate-900">...</h2>
                    <p id="profile-email" class="text-slate-400 font-bold mb-4">...</p>
                    <div id="profile-status-badge" class="inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-10">Free Starter</div>
                    
                    <div class="grid gap-3">
                        <button onclick="showView('view-plans')" class="w-full py-4 bg-indigo-50 text-indigo-600 rounded-2xl font-bold hover:bg-indigo-100">Manage Subscriptions</button>
                        <button onclick="signOut()" class="w-full py-4 text-red-500 font-bold hover:bg-red-50 rounded-2xl">Sign Out Session</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-sm glass-header rounded-[2.5rem] h-16 flex items-center justify-around px-6 shadow-2xl border border-white/50">
            <button onclick="showView('view-dashboard')" class="nav-item active text-xl"><i class="fa-solid fa-house"></i></button>
            <button onclick="showView('view-plans')" class="nav-item text-xl"><i class="fa-solid fa-crown"></i></button>
            <button id="admin-nav-mobile" onclick="showView('view-admin')" class="nav-item text-indigo-600 text-xl hidden"><i class="fa-solid fa-shield-halved"></i></button>
            <button onclick="showView('view-settings')" class="nav-item text-xl"><i class="fa-solid fa-users-gear"></i></button>
            <button onclick="showView('view-profile')" class="w-10 h-10 rounded-2xl overflow-hidden border-2 border-transparent active:border-indigo-600">
                <img id="mobile-nav-avatar" src="" class="w-full h-full object-cover">
            </button>
        </nav>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[600] bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center p-6">
        <div id="modal-content" class="w-full max-w-sm silk-card p-10 shadow-2xl scale-95 transition-transform duration-300">
            </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        /* --- Initialization & Configuration --- */
        const firebaseConfig = {
            apiKey: "AIzaSyCpLtdJ4lACW9pNn8fAUmooooqzh_5TIO4",
            authDomain: "trip-ddc48.firebaseapp.com",
            databaseURL: "https://trip-ddc48-default-rtdb.firebaseio.com",
            projectId: "trip-ddc48",
            storageBucket: "trip-ddc48.firebasestorage.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        const ADMIN_EMAIL = "akhilgoel985@gmail.com";
        let currentGroupId = null;
        let groupData = null;
        let currentUserPlan = 'Free';
        let activeUpgrade = null;

        /* --- Auth State Listener --- */
        auth.onAuthStateChanged(user => {
            if (user) {
                const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                
                // UI Setup for User
                document.getElementById('header-avatar').src = user.photoURL;
                document.getElementById('mobile-nav-avatar').src = user.photoURL;
                document.getElementById('profile-img-large').src = user.photoURL;
                document.getElementById('profile-name').innerText = user.displayName;
                document.getElementById('profile-email').innerText = user.email;

                // Admin Controls Toggle
                if (isAdmin) {
                    document.getElementById('admin-nav-desktop').classList.remove('hidden');
                    document.getElementById('admin-nav-mobile').classList.remove('hidden');
                    initAdminCenter();
                }

                initSubscriptionListener(user.uid);
                initGlobalBroadcasts();
                loadUserCircles(user.email.toLowerCase());
                
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('group-discovery').classList.remove('hidden');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        /* --- Global Subscription System --- */
        function initSubscriptionListener(uid) {
            db.ref(`active_subscriptions/${uid}`).on('value', snap => {
                const sub = snap.val();
                currentUserPlan = sub ? sub.tier : 'Free';
                const badge = document.getElementById('profile-status-badge');
                
                if (sub) {
                    badge.innerText = `${sub.tier} Cloud Pro`;
                    badge.className = "inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-10 bg-indigo-600 text-white";
                    document.getElementById('sub-crown').classList.remove('hidden');
                } else {
                    badge.innerText = "Free Starter";
                    badge.className = "inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-10 bg-slate-100 text-slate-500";
                    document.getElementById('sub-crown').classList.add('hidden');
                }
            });
        }

        /* --- Admin Command Center Logic --- */
        function initAdminCenter() {
            // 1. Stats Aggregation
            db.ref('groups').on('value', snap => {
                const groups = snap.val() || {};
                const keys = Object.keys(groups);
                let totalUsers = 0;
                let topGroup = { name: '...', count: 0 };

                keys.forEach(k => {
                    const mems = groups[k].members || [];
                    totalUsers += mems.length;
                    if (mems.length > topGroup.count) {
                        topGroup = { name: groups[k].name, count: mems.length };
                    }
                });

                document.getElementById('admin-stat-groups').innerText = keys.length;
                document.getElementById('admin-stat-users').innerText = totalUsers;
                document.getElementById('admin-stat-top-group').innerText = `${topGroup.name} (${topGroup.count})`;
            });

            // 2. Subscription Request Handler
            db.ref('subscription_requests').on('value', snap => {
                const list = document.getElementById('admin-sub-requests');
                const badge = document.getElementById('admin-sub-count');
                list.innerHTML = '';
                
                if (!snap.exists()) {
                    badge.innerText = '0';
                    list.innerHTML = '<div class="text-center py-20 text-slate-300 font-bold italic">No pending verifications</div>';
                    return;
                }

                const requests = snap.val();
                badge.innerText = Object.keys(requests).length;

                Object.entries(requests).forEach(([key, r]) => {
                    const card = `
                        <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="font-black text-sm">${r.userName}</h5>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">${r.userEmail}</p>
                                </div>
                                <span class="bg-indigo-600 text-white text-[9px] px-3 py-1 rounded-full font-black uppercase">${r.tier}</span>
                            </div>
                            <div class="bg-white p-3 rounded-xl mb-4 text-[11px] font-mono text-indigo-600 break-all border border-indigo-50">
                                TXID: ${r.txId}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="resolveSubscription('${key}', '${r.uid}', '${r.tier}', true, '${r.userName}')" class="flex-1 bg-slate-900 text-white py-3 rounded-xl text-[10px] font-black uppercase">Approve</button>
                                <button onclick="resolveSubscription('${key}', '${r.uid}', '${r.tier}', false)" class="flex-1 bg-white text-red-500 py-3 rounded-xl text-[10px] font-black uppercase border border-red-50">Deny</button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });
            });
        }

        async function resolveSubscription(reqKey, uid, tier, approved, name) {
            if (approved) {
                // Set active subscription
                await db.ref(`active_subscriptions/${uid}`).set({
                    tier: tier,
                    approvedAt: new Date().toISOString()
                });

                // Post a system message to a global announcements node
                db.ref('announcements').push({
                    text: `Elite Cloud Access Granted to ${name}! Welcome to the ${tier} circle.`,
                    type: 'system',
                    date: new Date().toLocaleTimeString()
                });

                showToast(`Subscription Approved for ${name}`);
            } else {
                showToast(`Request Denied`, 'error');
            }
            // Remove the request
            db.ref(`subscription_requests/${reqKey}`).remove();
        }

        function postBroadcast() {
            const msg = document.getElementById('admin-broadcast-msg').value.trim();
            if (!msg) return showToast("Enter a message", "error");

            db.ref('announcements').push({
                text: msg,
                by: 'System Admin',
                date: new Date().toLocaleTimeString()
            });

            document.getElementById('admin-broadcast-msg').value = '';
            showToast("Global Broadcast Pushed!");
        }

        function clearBroadcast() {
            db.ref('announcements').remove();
            showToast("All broadcasts cleared");
        }

        function initGlobalBroadcasts() {
            db.ref('announcements').limitToLast(1).on('value', snap => {
                const banner = document.getElementById('global-announcement');
                const text = document.getElementById('announcement-msg');
                
                if (snap.exists()) {
                    const data = Object.values(snap.val())[0];
                    text.innerText = data.text;
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }
            });
        }

        /* --- Circle Management Logic --- */
        function loadUserCircles(email) {
            db.ref('groups').on('value', snap => {
                const list = document.getElementById('discovery-list');
                list.innerHTML = '';
                const groups = snap.val() || {};

                Object.entries(groups).forEach(([id, g]) => {
                    const members = g.members || [];
                    if (members.some(m => m.email.toLowerCase() === email)) {
                        const card = `
                            <div onclick="enterCircle('${id}', '${g.name}')" class="silk-card p-6 flex justify-between items-center cursor-pointer hover:border-indigo-100 group">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-colors">
                                        <i class="fa-solid fa-users-viewfinder"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-extrabold text-slate-900 leading-none mb-1">${g.name}</h4>
                                        <p class="text-[9px] font-black text-indigo-500 uppercase">${id}</p>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right text-slate-200 group-hover:text-indigo-200 group-hover:translate-x-1 transition-all"></i>
                            </div>
                        `;
                        list.innerHTML += card;
                    }
                });
            });
        }

        function enterCircle(id, name) {
            currentGroupId = id;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Sync with Circle
            db.ref(`groups/${id}`).on('value', snap => {
                groupData = snap.val();
                if (!groupData) return;
                
                document.getElementById('current-group-name').innerText = groupData.name;
                document.getElementById('current-group-id-display').innerText = id;
                document.getElementById('settings-group-name').innerText = groupData.name;
                
                const isAdmin = groupData.admin.toLowerCase() === auth.currentUser.email.toLowerCase();
                document.getElementById('admin-only-tools').classList.toggle('hidden', !isAdmin);

                renderDashboard();
                renderSettings();
            });
        }

        /* --- Core Dashboard Rendering --- */
        function renderDashboard() {
            const expenses = groupData.expenses || {};
            const members = groupData.members || [];
            
            let totalSpend = 0;
            const balances = {};
            members.forEach(m => balances[m.name] = 0);

            // 1. Process Timeline
            const feed = document.getElementById('timeline-feed');
            feed.innerHTML = '';
            
            const sortedEntries = Object.entries(expenses).reverse();
            sortedEntries.forEach(([key, e]) => {
                const amt = parseFloat(e.amount);
                if (e.type === 'expense') {
                    totalSpend += amt;
                    const split = amt / e.involved.length;
                    e.involved.forEach(name => balances[name] += split);
                } else if (e.type === 'settlement') {
                    balances[e.payer] -= amt;
                }

                feed.innerHTML += `
                    <div class="silk-card p-6 flex justify-between items-center bg-white border-none">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl ${e.type === 'expense' ? 'bg-slate-50 text-slate-400' : 'bg-green-50 text-green-500'} flex items-center justify-center">
                                <i class="fa-solid ${e.type === 'expense' ? 'fa-receipt' : 'fa-hand-holding-dollar'}"></i>
                            </div>
                            <div>
                                <h5 class="font-black text-sm text-slate-900">${e.title}</h5>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">${e.date} • by ${e.by}</p>
                            </div>
                        </div>
                        <p class="text-xl font-black ${e.type === 'settlement' ? 'text-green-600' : 'text-slate-900'}">₹${Math.round(amt)}</p>
                    </div>
                `;
            });

            document.getElementById('grand-total').innerText = `₹${Math.round(totalSpend)}`;

            // 2. Render Stats Grid
            const statsGrid = document.getElementById('dashboard-stats');
            statsGrid.innerHTML = members.map((m, i) => `
                <div class="silk-card p-6 text-center">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">${m.name}</p>
                    <p class="text-2xl font-black text-slate-900">₹${Math.round(balances[m.name])}</p>
                    <div class="w-full h-1 bg-slate-50 mt-4 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500" style="width: ${Math.min((balances[m.name]/totalSpend)*100 || 0, 100)}%"></div>
                    </div>
                </div>
            `).join('');

            // 3. Render Splitting Selectors
            document.getElementById('split-selectors').innerHTML = members.map(m => `
                <button onclick="toggleChip(this)" data-name="${m.name}" class="chip-active px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest bg-indigo-600 text-white transition-all shadow-md shadow-indigo-100">${m.name}</button>
            `).join('');
        }

        /* --- Settings & Group Control --- */
        function renderSettings() {
            const list = document.getElementById('settings-member-list');
            const members = groupData.members || [];
            document.getElementById('member-count-badge').innerText = `${members.length} Participants`;
            
            list.innerHTML = members.map((m, i) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center font-black text-[10px] text-indigo-500">${m.name[0]}</div>
                        <div>
                            <p class="text-sm font-black text-slate-900 leading-none mb-1">${m.name}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">${m.email}</p>
                        </div>
                    </div>
                    ${groupData.admin.toLowerCase() === m.email.toLowerCase() ? '<span class="text-[8px] font-black text-indigo-600 border border-indigo-200 px-2 py-0.5 rounded">ADMIN</span>' : ''}
                </div>
            `).join('');
        }

        async function adminManualAdd() {
            const name = document.getElementById('add-mem-name').value.trim();
            const email = document.getElementById('add-mem-email').value.trim().toLowerCase();

            if (!name || !email) return showToast("Enter all details", "error");
            
            const updatedMembers = [...groupData.members, { name: name.split(' ')[0], email: email }];
            await db.ref(`groups/${currentGroupId}/members`).set(updatedMembers);
            
            document.getElementById('add-mem-name').value = '';
            document.getElementById('add-mem-email').value = '';
            showToast("Member Added Successfully!");
        }

        /* --- Transaction Handling --- */
        async function publishTransaction() {
            const title = document.getElementById('log-title').value.trim();
            const amount = document.getElementById('log-amount').value.trim();
            const involved = Array.from(document.querySelectorAll('.chip-active')).map(c => c.dataset.name);

            if (!title || !amount || involved.length === 0) return showToast("Please fill all details", "error");

            const newExp = {
                title: title,
                amount: amount,
                involved: involved,
                by: auth.currentUser.displayName.split(' ')[0],
                date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                type: 'expense'
            };

            await db.ref(`groups/${currentGroupId}/expenses`).push(newExp);
            
            document.getElementById('log-title').value = '';
            document.getElementById('log-amount').value = '';
            showToast("Transaction Recorded");
        }

        /* --- Subscription Upgrade Flow --- */
        function requestSub(tier, price) {
            activeUpgrade = { tier, price };
            const upiUrl = `upi://pay?pa=akhilgoel985-2@okaxis&pn=Akhil%20Goel&am=${price}&cu=INR&tn=TripSplitPro_${tier}`;
            document.getElementById('qr-display').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiUrl)}`;
            document.getElementById('pay-amount-label').innerText = `₹${price}`;
            
            document.getElementById('payment-gateway').classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function finalizeSubRequest() {
            const txId = document.getElementById('pay-tx-id').value.trim();
            if (!txId) return showToast("Transaction ID required", "error");

            const request = {
                uid: auth.currentUser.uid,
                userName: auth.currentUser.displayName,
                userEmail: auth.currentUser.email,
                tier: activeUpgrade.tier,
                txId: txId,
                status: 'pending',
                requestedAt: new Date().toISOString()
            };

            await db.ref('subscription_requests').push(request);
            
            document.getElementById('payment-gateway').classList.add('hidden');
            document.getElementById('pay-tx-id').value = '';
            showToast("Request Sent! Verification usually takes 1 hour.");
        }

        /* --- UI Helpers --- */
        function showView(viewId) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
            
            // Update Navigation UI
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.nav-btn-desktop').forEach(b => b.classList.remove('active-nav', 'bg-white', 'shadow-sm', 'text-indigo-600'));

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleChip(btn) {
            btn.classList.toggle('chip-active');
            btn.classList.toggle('bg-indigo-600');
            btn.classList.toggle('text-white');
            btn.classList.toggle('bg-slate-100');
            btn.classList.toggle('text-slate-400');
            btn.classList.toggle('shadow-md');
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast silk-card px-6 py-4 flex items-center gap-3 border-none shadow-2xl bg-white`;
            toast.innerHTML = `
                <div class="w-2 h-2 rounded-full ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}"></div>
                <span class="text-xs font-black uppercase tracking-widest text-slate-700">${msg}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function openModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            if (type === 'modal-create') {
                content.innerHTML = `
                    <h3 class="text-2xl font-black mb-6 text-center">Create Circle</h3>
                    <input type="text" id="new-circle-name" placeholder="E.g. Goa Trip 2026" class="w-full bg-slate-50 p-4 rounded-2xl mb-6 border-none outline-none font-bold">
                    <div class="flex gap-2">
                        <button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400">Cancel</button>
                        <button onclick="finalizeCircleCreation()" class="flex-1 btn-premium py-4">Create</button>
                    </div>
                `;
            } else if (type === 'modal-join') {
                content.innerHTML = `
                    <h3 class="text-2xl font-black mb-6 text-center">Join Circle</h3>
                    <input type="text" id="join-id" placeholder="ENTER CIRCLE ID" class="w-full bg-slate-50 p-4 rounded-2xl mb-6 border-none outline-none font-black text-center uppercase tracking-widest">
                    <div class="flex gap-2">
                        <button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400">Cancel</button>
                        <button onclick="finalizeJoinRequest()" class="flex-1 btn-premium py-4 text-xs">Send Request</button>
                    </div>
                `;
            }
        }

        async function finalizeCircleCreation() {
            const name = document.getElementById('new-circle-name').value.trim();
            if (!name) return;

            const id = "PRO-" + Math.random().toString(36).substring(2, 6).toUpperCase();
            const newGroup = {
                name: name,
                admin: auth.currentUser.email.toLowerCase(),
                members: [{
                    name: auth.currentUser.displayName.split(' ')[0],
                    email: auth.currentUser.email.toLowerCase()
                }]
            };

            await db.ref(`groups/${id}`).set(newGroup);
            closeModal();
            showToast("Circle Created!");
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function copyID() {
            navigator.clipboard.writeText(currentGroupId);
            showToast("ID Copied to Clipboard");
        }

        function signOut() {
            auth.signOut().then(() => location.reload());
        }

        /* --- Startup --- */
        showView('view-dashboard');

    </script>
</body>
</html>
